

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>core.utils &mdash; PySegCNN  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> PySegCNN
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../source/requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/api.html">API Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PySegCNN</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>core.utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for core.utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Utility functions mainly for image IO and reshaping.</span>

<span class="sd">License</span>
<span class="sd">-------</span>

<span class="sd">    Copyright (c) 2020 Daniel Frisinghelli</span>

<span class="sd">    This source code is licensed under the GNU General Public License v3.</span>

<span class="sd">    See the LICENSE file in the repository&#39;s root directory.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># !/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># builtins</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="c1"># externals</span>
<span class="kn">import</span> <span class="nn">gdal</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># module level logger</span>
<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># suffixes for radiometrically calibrated scenes</span>
<span class="n">SUFFIXES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;toa_ref&#39;</span><span class="p">,</span> <span class="s1">&#39;toa_rad&#39;</span><span class="p">,</span> <span class="s1">&#39;toa_brt&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="img2np"><a class="viewcode-back" href="../../source/core.html#core.utils.img2np">[docs]</a><span class="k">def</span> <span class="nf">img2np</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">tile_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cval</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read an image to a `numpy.ndarray`.</span>

<span class="sd">    If ``tile_size`` is not `None`, the input image is divided into square</span>
<span class="sd">    tiles of size (``tile_size``, ``tile_size``). If the image is not evenly</span>
<span class="sd">    divisible and ``pad`` = False, a `ValueError` is raised. However, if</span>
<span class="sd">    ``pad`` = True, center padding with constant value ``cval`` is applied.</span>

<span class="sd">    The tiling works as follows:</span>

<span class="sd">        (Padded) Input image:</span>

<span class="sd">        ------------------------------------------------</span>
<span class="sd">        |           |           |          |           |</span>
<span class="sd">        |  tile_00  |  tile_01  |    ...   |  tile_0n  |</span>
<span class="sd">        |           |           |          |           |</span>
<span class="sd">        |----------------------------------------------|</span>
<span class="sd">        |           |           |          |           |</span>
<span class="sd">        |  tile_10  |  tile_11  |    ...   |  tile_1n  |</span>
<span class="sd">        |           |           |          |           |</span>
<span class="sd">        |----------------------------------------------|</span>
<span class="sd">        |           |           |          |           |</span>
<span class="sd">        |    ...    |    ...    |    ...   |    ...    |</span>
<span class="sd">        |           |           |          |           |</span>
<span class="sd">        |----------------------------------------------|</span>
<span class="sd">        |           |           |          |           |</span>
<span class="sd">        |  tile_m0  |  tile_m1  |    ...   |  tile_mn  |</span>
<span class="sd">        |           |           |          |           |</span>
<span class="sd">        ------------------------------------------------</span>

<span class="sd">    where m = n. Each tile has its id, which starts at 0 in the topleft corner</span>
<span class="sd">    of the input image, i.e. tile_00 has id=0, and increases along the width</span>
<span class="sd">    axis, i.e. tile_0n has id=n, tile_10 has id=n+1, ..., tile_mn has</span>
<span class="sd">    id=(m * n) - 1.</span>

<span class="sd">    If ``tile`` is an integer, only the tile with id = ``tile`` is returned.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : `str` or `None` or `numpy.ndarray`</span>
<span class="sd">        The image to read.</span>
<span class="sd">    tile_size : `None` or `int`, optional</span>
<span class="sd">        The size of a tile. The default is None.</span>
<span class="sd">    tile : `int`, optional</span>
<span class="sd">        The tile id. The default is None.</span>
<span class="sd">    pad : `bool`, optional</span>
<span class="sd">        Whether to center pad the input image. The default is False.</span>
<span class="sd">    cval : `float`, optional</span>
<span class="sd">        The constant padding value. The default is 0.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        Raised if ``path`` is a path that does not exist.</span>
<span class="sd">    TypeError</span>
<span class="sd">        Raised if ``path`` is not `str` or `None` or `numpy.ndarray`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    image : `numpy.ndarray`</span>
<span class="sd">        The image array. The output shape is:</span>

<span class="sd">            if ``tile_size`` is not `None`:</span>
<span class="sd">                shape=(tiles, bands, tile_size, tile_size)</span>
<span class="sd">                if the image does only have one band:</span>
<span class="sd">                    shape=(tiles, tile_size, tile_size)</span>

<span class="sd">            else:</span>
<span class="sd">                shape=(bands, height, width)</span>
<span class="sd">                if the image does only have one band:</span>
<span class="sd">                    shape=(height, width)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># check the type of path</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> does not exist.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="c1"># the image dataset as returned by gdal</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># number of bands</span>
        <span class="n">bands</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">RasterCount</span>

        <span class="c1"># spatial size</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">RasterYSize</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">RasterXSize</span>

    <span class="k">elif</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Path is of NoneType, returning.&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># accept numpy arrays as input</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">bands</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Input of type </span><span class="si">{}</span><span class="s1"> not supported&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">img</span><span class="p">)))</span>

    <span class="c1"># check whether to read the image in tiles</span>
    <span class="k">if</span> <span class="n">tile_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># number of tiles</span>
        <span class="n">ntiles</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># create empty numpy array to store whole image</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">ntiles</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">))</span>

        <span class="c1"># iterate over the bands of the image</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bands</span><span class="p">):</span>

            <span class="c1"># read the data of band b</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">band</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>

            <span class="c1"># append band b to numpy image array</span>
            <span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="c1"># check whether the image is evenly divisible in square tiles</span>
        <span class="c1"># of size (tile_size x tile_size)</span>
        <span class="n">ntiles</span><span class="p">,</span> <span class="n">padding</span> <span class="o">=</span> <span class="n">is_divisible</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">pad</span><span class="p">)</span>

        <span class="c1"># image size after padding</span>
        <span class="n">y_size</span> <span class="o">=</span> <span class="n">height</span> <span class="o">+</span> <span class="n">padding</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">padding</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">x_size</span> <span class="o">=</span> <span class="n">width</span> <span class="o">+</span> <span class="n">padding</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">padding</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="c1"># print progress</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Image size: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)))</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Dividing image into </span><span class="si">{}</span><span class="s1"> tiles of size </span><span class="si">{}</span><span class="s1"> ...&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ntiles</span><span class="p">,</span> <span class="p">(</span><span class="n">tile_size</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">)))</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Padding image (b, l, t, r): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">padding</span><span class="p">)))</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Padded image size: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">y_size</span><span class="p">,</span> <span class="n">x_size</span><span class="p">)))</span>

        <span class="c1"># get the indices of the top left corner for each tile</span>
        <span class="n">topleft</span> <span class="o">=</span> <span class="n">tile_topleft_corner</span><span class="p">((</span><span class="n">y_size</span><span class="p">,</span> <span class="n">x_size</span><span class="p">),</span> <span class="n">tile_size</span><span class="p">)</span>

        <span class="c1"># whether to read all tiles or a single tile</span>
        <span class="k">if</span> <span class="n">tile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ntiles</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># create empty numpy array to store the tiles</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ntiles</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">))</span> <span class="o">*</span> <span class="n">cval</span>

        <span class="c1"># iterate over the topleft corners of the tiles</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">corner</span> <span class="ow">in</span> <span class="n">topleft</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="c1"># in case a single tile is required, skip the rest of the tiles</span>
            <span class="k">if</span> <span class="n">tile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">tile</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># set the key to 0 for correct array indexing when reading</span>
                <span class="c1"># a single tile from the image</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Processing tile </span><span class="si">{}</span><span class="s1"> ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Creating tile </span><span class="si">{}</span><span class="s1"> with top-left corner </span><span class="si">{}</span><span class="s1"> ...&#39;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">corner</span><span class="p">))</span>

            <span class="c1"># calculate shift between padded and original image</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">corner</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">padding</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">corner</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">corner</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">padding</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">corner</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">y_tl</span> <span class="o">=</span> <span class="n">row</span> <span class="o">+</span> <span class="n">padding</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">x_tl</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="n">padding</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

            <span class="c1"># iterate over the bands of the image</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bands</span><span class="p">):</span>

                <span class="c1"># check if the current tile extend exists in the image</span>
                <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">check_tile_extend</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">),</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">),</span> <span class="n">tile_size</span><span class="p">)</span>

                <span class="c1"># read the current tile from band b</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span><span class="n">row</span><span class="o">+</span><span class="n">nrows</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span><span class="n">col</span><span class="o">+</span><span class="n">ncols</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">band</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span><span class="p">)</span>

                <span class="c1"># append band b to numpy image array</span>
                <span class="n">image</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">y_tl</span><span class="p">:</span><span class="n">nrows</span><span class="p">,</span> <span class="n">x_tl</span><span class="p">:</span><span class="n">ncols</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:(</span><span class="n">nrows</span> <span class="o">-</span> <span class="n">y_tl</span><span class="p">),</span>
                                                           <span class="mi">0</span><span class="p">:(</span><span class="n">ncols</span> <span class="o">-</span> <span class="n">x_tl</span><span class="p">)]</span>

    <span class="c1"># check if there are more than 1 band</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bands</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># check if there are more than 1 tile</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ntiles</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># close tif file</span>
    <span class="k">del</span> <span class="n">img</span>

    <span class="c1"># return the image</span>
    <span class="k">return</span> <span class="n">image</span></div>


<div class="viewcode-block" id="is_divisible"><a class="viewcode-back" href="../../source/core.html#core.utils.is_divisible">[docs]</a><span class="k">def</span> <span class="nf">is_divisible</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check whether an image is evenly divisible into square tiles.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img_size : `tuple`</span>
<span class="sd">        The image size (height, width).</span>
<span class="sd">    tile_size : `int`</span>
<span class="sd">        The size of the tile.</span>
<span class="sd">    pad : `bool`, optional</span>
<span class="sd">        Whether to center pad the input image. The default is False.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Raised if the image is not evenly divisible and ``pad`` = False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ntiles : `int`</span>
<span class="sd">        The number of tiles fitting ``img_size``.</span>
<span class="sd">    padding : `tuple`</span>
<span class="sd">        The amount of padding (bottom, left, top, right).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># calculate number of pixels per tile</span>
    <span class="n">pixels_per_tile</span> <span class="o">=</span> <span class="n">tile_size</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="c1"># check whether the image is evenly divisible in square tiles of size</span>
    <span class="c1"># (tile_size, tile_size)</span>
    <span class="n">ntiles</span> <span class="o">=</span> <span class="p">((</span><span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">pixels_per_tile</span><span class="p">)</span>

    <span class="c1"># if it is evenly divisible, no padding is required</span>
    <span class="k">if</span> <span class="n">ntiles</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ntiles</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pad</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Image of size </span><span class="si">{}</span><span class="s1"> not evenly divisible in (</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">) &#39;</span>
                         <span class="s1">&#39;tiles.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ntiles</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()</span> <span class="ow">and</span> <span class="n">pad</span><span class="p">:</span>

        <span class="c1"># calculate the desired image size, i.e. the smallest size that is</span>
        <span class="c1"># evenly divisible into square tiles of size (tile_size, tile_size)</span>
        <span class="n">h_new</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">tile_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">tile_size</span><span class="p">)</span>
        <span class="n">w_new</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">tile_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">tile_size</span><span class="p">)</span>

        <span class="c1"># calculate center offset</span>
        <span class="n">dh</span> <span class="o">=</span> <span class="n">h_new</span> <span class="o">-</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dw</span> <span class="o">=</span> <span class="n">w_new</span> <span class="o">-</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># check whether the center offsets are even or odd</span>

        <span class="c1"># in case both offsets are even, the padding is symmetric on both the</span>
        <span class="c1"># bottom/top and left/right</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dh</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dw</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">dh</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dw</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dh</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dw</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># in case only one offset is even, the padding is symmetric along the</span>
        <span class="c1"># even offset and asymmetric along the odd offset</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dh</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">dw</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">dh</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dw</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dh</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dw</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dh</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dw</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">dh</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dw</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dh</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dw</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># in case of offsets are odd, the padding is asymmetric on both the</span>
        <span class="c1"># bottom/top and left/right</span>
        <span class="k">if</span> <span class="n">dh</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">dw</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">dh</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dw</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dh</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dw</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># calculate number of tiles on padded image</span>
        <span class="n">ntiles</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_new</span> <span class="o">*</span> <span class="n">w_new</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tile_size</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">ntiles</span><span class="p">),</span> <span class="n">padding</span></div>


<div class="viewcode-block" id="check_tile_extend"><a class="viewcode-back" href="../../source/core.html#core.utils.check_tile_extend">[docs]</a><span class="k">def</span> <span class="nf">check_tile_extend</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">topleft</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if a tile exceeds the image size.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img_size : `tuple`</span>
<span class="sd">        The image size (height, width).</span>
<span class="sd">    topleft : `tuple`</span>
<span class="sd">        The topleft corner of the tile (y, x).</span>
<span class="sd">    tile_size : `int`</span>
<span class="sd">        The size of the tile.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nrows : `int`</span>
<span class="sd">        Number of rows of the tile within the image.</span>
<span class="sd">    ncols : TYPE</span>
<span class="sd">        Number of columns of the tile within the image.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># check if the tile is within both the rows and the columns of the image</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">topleft</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile_size</span> <span class="o">&lt;</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span>
            <span class="n">topleft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile_size</span> <span class="o">&lt;</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

        <span class="c1"># both rows and columns can be equal to the tile size</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">tile_size</span>

    <span class="c1"># check if the tile exceeds one of rows or columns of the image</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">topleft</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile_size</span> <span class="o">&lt;</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span>
            <span class="n">topleft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile_size</span> <span class="o">&lt;</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

        <span class="c1"># adjust columns to remaining columns in the original image</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">topleft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">topleft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile_size</span> <span class="o">&lt;</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span>
            <span class="n">topleft</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile_size</span> <span class="o">&lt;</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

        <span class="c1"># adjust rows to remaining rows in the original image</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">topleft</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tile_size</span>

    <span class="c1"># check if the tile exceeds both the rows and the columns of the image</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">topleft</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile_size</span> <span class="o">&lt;</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span>
            <span class="n">topleft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile_size</span> <span class="o">&lt;</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

        <span class="c1"># adjust both rows and columns to the remaining ones</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">topleft</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">topleft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span></div>


<div class="viewcode-block" id="tile_topleft_corner"><a class="viewcode-back" href="../../source/core.html#core.utils.tile_topleft_corner">[docs]</a><span class="k">def</span> <span class="nf">tile_topleft_corner</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the topleft corners of the tiles in the image.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img_size : `tuple`</span>
<span class="sd">        The image size (height, width).</span>
<span class="sd">    tile_size : `int`</span>
<span class="sd">        The size of the tile.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    indices : `dict`</span>
<span class="sd">        The keys of ``indices`` are the tile ids (`int`) and the values are the</span>
<span class="sd">        topleft corners (`tuple` = (y, x)) of the tiles.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># check if the image is divisible into square tiles of size</span>
    <span class="c1"># (tile_size, tile_size)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">is_divisible</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># number of tiles along the width (columns) of the image</span>
    <span class="n">ntiles_columns</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">tile_size</span><span class="p">)</span>

    <span class="c1"># number of tiles along the height (rows) of the image</span>
    <span class="n">ntiles_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">tile_size</span><span class="p">)</span>

    <span class="c1"># get the indices of the top left corner for each tile</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntiles_rows</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntiles_columns</span><span class="p">):</span>
            <span class="n">indices</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">tile_size</span><span class="p">,</span> <span class="n">j</span> <span class="o">*</span> <span class="n">tile_size</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">indices</span></div>


<div class="viewcode-block" id="reconstruct_scene"><a class="viewcode-back" href="../../source/core.html#core.utils.reconstruct_scene">[docs]</a><span class="k">def</span> <span class="nf">reconstruct_scene</span><span class="p">(</span><span class="n">tiles</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reconstruct a tiled image.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tiles : `torch.Tensor` or `numpy.ndarray`</span>
<span class="sd">        The tiled image, shape=(tiles, bands, tile_size, tile_size) or</span>
<span class="sd">        shape=(tiles, tile_size, tile_size).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    image : `numpy.ndarray`</span>
<span class="sd">        The reconstructed image.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># convert to numpy array</span>
    <span class="n">tiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">tiles</span><span class="p">)</span>

    <span class="c1"># check the size</span>
    <span class="k">if</span> <span class="n">tiles</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">nbands</span> <span class="o">=</span> <span class="n">tiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tile_size</span> <span class="o">=</span> <span class="n">tiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nbands</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">tile_size</span> <span class="o">=</span> <span class="n">tiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># calculate image size</span>
    <span class="n">img_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">tile_size</span><span class="p">),)</span>

    <span class="c1"># calculate the topleft corners of the tiles</span>
    <span class="n">topleft</span> <span class="o">=</span> <span class="n">tile_topleft_corner</span><span class="p">(</span><span class="n">img_size</span><span class="p">,</span> <span class="n">tile_size</span><span class="p">)</span>

    <span class="c1"># iterate over the tiles</span>
    <span class="n">scene</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nbands</span><span class="p">,)</span> <span class="o">+</span> <span class="n">img_size</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">scene</span><span class="p">[</span><span class="o">...</span><span class="p">,</span>
              <span class="n">topleft</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span> <span class="n">topleft</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile_size</span><span class="p">,</span>
              <span class="n">topleft</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span> <span class="n">topleft</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tile_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">tiles</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">scene</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span></div>


<div class="viewcode-block" id="accuracy_function"><a class="viewcode-back" href="../../source/core.html#core.utils.accuracy_function">[docs]</a><span class="k">def</span> <span class="nf">accuracy_function</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate prediction accuracy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    outputs : `torch.Tensor` or array_like</span>
<span class="sd">        The model prediction.</span>
<span class="sd">    labels : `torch.Tensor` or array_like</span>
<span class="sd">        The ground truth.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    accuracy : `float`</span>
<span class="sd">        Mean prediction accuracy.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">outputs</span> <span class="o">==</span> <span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span></div>


<div class="viewcode-block" id="parse_landsat_scene"><a class="viewcode-back" href="../../source/core.html#core.utils.parse_landsat_scene">[docs]</a><span class="k">def</span> <span class="nf">parse_landsat_scene</span><span class="p">(</span><span class="n">scene_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse a Landsat scene identifier.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scene_id : `str`</span>
<span class="sd">        A Landsat scene identifier.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    scene : `dict` or `None`</span>
<span class="sd">        A dictionary containing scene metadata. If `None`, ``scene_id`` is not</span>
<span class="sd">        a valid Landsat scene identifier.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Landsat Collection 1 naming convention in regular expression</span>
    <span class="n">sensor</span> <span class="o">=</span> <span class="s1">&#39;L[COTEM]0[1-8]_&#39;</span>
    <span class="n">level</span> <span class="o">=</span> <span class="s1">&#39;L[0-9][A-Z][A-Z]_&#39;</span>
    <span class="n">swath</span> <span class="o">=</span> <span class="s1">&#39;[0-2][0-9]</span><span class="si">{2}</span><span class="s1">[0-1][0-9]</span><span class="si">{2}</span><span class="s1">_&#39;</span>
    <span class="n">date</span> <span class="o">=</span> <span class="s1">&#39;[0-9]</span><span class="si">{4}</span><span class="s1">[0-1][0-9][0-3][0-9]_&#39;</span>
    <span class="n">doy</span> <span class="o">=</span> <span class="s1">&#39;[0-9]</span><span class="si">{4}</span><span class="s1">[0-3][0-9]</span><span class="si">{2}</span><span class="s1">&#39;</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="s1">&#39;0[0-9]_&#39;</span>
    <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;[A-Z]([A-Z]|[0-9])&#39;</span>

    <span class="c1"># Landsat Collection 1 naming</span>
    <span class="n">C1</span> <span class="o">=</span> <span class="p">(</span><span class="n">sensor</span> <span class="o">+</span> <span class="n">level</span> <span class="o">+</span> <span class="n">swath</span> <span class="o">+</span> <span class="n">date</span> <span class="o">+</span> <span class="n">date</span> <span class="o">+</span> <span class="n">collection</span> <span class="o">+</span> <span class="n">category</span><span class="p">)</span>
    <span class="n">Landsat_C1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">C1</span><span class="p">)</span>

    <span class="c1"># Landsat naming convention before Collections</span>
    <span class="n">C0</span> <span class="o">=</span> <span class="p">(</span><span class="n">sensor</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">swath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span>
          <span class="n">doy</span> <span class="o">+</span> <span class="s1">&#39;[A-Z]</span><span class="si">{3}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;[0-9]</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">Landsat_C0</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">C0</span><span class="p">)</span>

    <span class="c1"># mapping from sensor id to sensors</span>
    <span class="n">lsensors</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="s1">&#39;Enhanced Thematic Mapper Plus&#39;</span><span class="p">,</span>
                <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;Thematic Mapper&#39;</span><span class="p">,</span>
                <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="s1">&#39;Multispectral Scanner&#39;</span><span class="p">}</span>
    <span class="n">l8sensors</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="s1">&#39;Operational Land Imager (OLI) &amp; Thermal Infrared Sensor&#39;</span>
                      <span class="s1">&#39; (TIRS)&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="s1">&#39;Operational Land Imager (OLI)&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;Thermal Infrared Sensor (TIRS)&#39;</span><span class="p">,</span>
                 <span class="p">}</span>

    <span class="c1"># whether a scene identifier matches the Landsat naming convention</span>
    <span class="n">scene</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">Landsat_C0</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">scene_id</span><span class="p">):</span>

        <span class="c1"># the match of the regular expression</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">Landsat_C0</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">scene_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># the metadata of the scene identifier</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;satellite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Landsat </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;sensor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l8sensors</span><span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;sensor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lsensors</span><span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">doy2date</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">13</span><span class="p">],</span> <span class="n">match</span><span class="p">[</span><span class="mi">13</span><span class="p">:</span><span class="mi">16</span><span class="p">])</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;gsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">19</span><span class="p">]</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="mi">19</span><span class="p">:]</span>

    <span class="k">elif</span> <span class="n">Landsat_C1</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">scene_id</span><span class="p">):</span>

        <span class="c1"># the match of the regular expression</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">Landsat_C1</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">scene_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># split scene into respective parts</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>

        <span class="c1"># the metadata of the scene identifier</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;satellite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Landsat </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">:])</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;sensor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l8sensors</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;sensor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lsensors</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">:]</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;collection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">scene</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">scene</span></div>


<div class="viewcode-block" id="parse_sentinel2_scene"><a class="viewcode-back" href="../../source/core.html#core.utils.parse_sentinel2_scene">[docs]</a><span class="k">def</span> <span class="nf">parse_sentinel2_scene</span><span class="p">(</span><span class="n">scene_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse a Sentinel-2 scene identifier.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scene_id : `str`</span>
<span class="sd">        A Sentinel-2 scene identifier.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    scene : `dict` or `None`</span>
<span class="sd">        A dictionary containing scene metadata. If `None`, ``scene_id`` is not</span>
<span class="sd">        a valid Sentinel-2 scene identifier.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Sentinel 2 Level-1C products naming convention after 6th December 2016</span>
    <span class="n">mission</span> <span class="o">=</span> <span class="s1">&#39;S2[A-B]_&#39;</span>
    <span class="n">level</span> <span class="o">=</span> <span class="s1">&#39;MSIL1C_&#39;</span>
    <span class="n">date</span> <span class="o">=</span> <span class="s1">&#39;[0-9]</span><span class="si">{4}</span><span class="s1">[0-1][0-9][0-3][0-9]&#39;</span>
    <span class="n">time</span> <span class="o">=</span> <span class="s1">&#39;T[0-2][0-9][0-5][0-9][0-5][0-9]_&#39;</span>
    <span class="n">processing</span> <span class="o">=</span> <span class="s1">&#39;N[0-9]</span><span class="si">{4}</span><span class="s1">_&#39;</span>
    <span class="n">orbit</span> <span class="o">=</span> <span class="s1">&#39;R[0-1][0-9]</span><span class="si">{2}</span><span class="s1">_&#39;</span>
    <span class="n">tile</span> <span class="o">=</span> <span class="s1">&#39;T[0-9]</span><span class="si">{2}</span><span class="s1">[A-Z]</span><span class="si">{3}</span><span class="s1">_&#39;</span>
    <span class="n">level_1C</span> <span class="o">=</span> <span class="p">(</span><span class="n">mission</span> <span class="o">+</span> <span class="n">level</span> <span class="o">+</span> <span class="n">date</span> <span class="o">+</span> <span class="n">time</span> <span class="o">+</span> <span class="n">processing</span> <span class="o">+</span>
                <span class="n">orbit</span> <span class="o">+</span> <span class="n">tile</span> <span class="o">+</span> <span class="n">date</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="n">S2_L1C_New</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">level_1C</span><span class="p">)</span>

    <span class="c1"># Sentinel 2 Level-1C products naming convention before 6th December 2016</span>
    <span class="n">file_class</span> <span class="o">=</span> <span class="s1">&#39;[A-Z]</span><span class="si">{4}</span><span class="s1">_&#39;</span>
    <span class="n">file_category</span> <span class="o">=</span> <span class="s1">&#39;[A-Z]</span><span class="si">{3}</span><span class="s1">_&#39;</span>
    <span class="n">file_semantic</span> <span class="o">=</span> <span class="s1">&#39;L[0-1]([ABC]|_)_[A-Z]</span><span class="si">{2}</span><span class="s1">_&#39;</span>
    <span class="n">site</span> <span class="o">=</span> <span class="s1">&#39;[A-Z_]</span><span class="si">{4}</span><span class="s1">_&#39;</span>
    <span class="n">aorbit</span> <span class="o">=</span> <span class="s1">&#39;A[0-9]</span><span class="si">{6}</span><span class="s1">_&#39;</span>
    <span class="n">S2_L1C_Old</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">mission</span> <span class="o">+</span> <span class="n">file_class</span> <span class="o">+</span> <span class="n">file_category</span> <span class="o">+</span>
                            <span class="n">file_semantic</span> <span class="o">+</span> <span class="n">site</span> <span class="o">+</span> <span class="s1">&#39;V&#39;</span> <span class="o">+</span> <span class="n">date</span> <span class="o">+</span> <span class="n">time</span> <span class="o">+</span> <span class="n">aorbit</span> <span class="o">+</span>
                            <span class="n">tile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

    <span class="c1"># ProSnow project naming convention</span>
    <span class="n">ProSnow</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">tile</span> <span class="o">+</span> <span class="n">date</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

    <span class="c1"># whether a scene identifier matches the Sentinel naming convention</span>
    <span class="n">scene</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">S2_L1C_Old</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">scene_id</span><span class="p">):</span>

        <span class="c1"># the match of the regular expression</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">S2_L1C_Old</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">scene_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># split scene into respective parts</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>

        <span class="c1"># the metadata of the scene identifier</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;satellite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Sentinel </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;file class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;file category&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;file semantic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;orbit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
           <span class="n">parts</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">S2_L1C_New</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">scene_id</span><span class="p">):</span>

        <span class="c1"># the match of the regular expression</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">S2_L1C_New</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">scene_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># split scene into respective parts</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>

        <span class="c1"># the metadata of the scene identifier</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;satellite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Sentinel </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;product&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                                   <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;baseline&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;orbit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;tile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">ProSnow</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">scene_id</span><span class="p">):</span>

        <span class="c1"># the match of the regular expression</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">ProSnow</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">scene_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># split scene into respective parts</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>

        <span class="c1"># the metadata of the scene identifier</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;satellite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Sentinel 2&#39;</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;tile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                                   <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">scene</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">scene</span></div>


<div class="viewcode-block" id="doy2date"><a class="viewcode-back" href="../../source/core.html#core.utils.doy2date">[docs]</a><span class="k">def</span> <span class="nf">doy2date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">doy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert the (year, day of the year) date format to a datetime object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    year : `int`</span>
<span class="sd">        The year</span>
<span class="sd">    doy : `int`</span>
<span class="sd">        The day of the year</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    date : `datetime.datetime`</span>
<span class="sd">        The converted date.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># convert year/day of year to a datetime object</span>
    <span class="n">date</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">date</span></div>


<div class="viewcode-block" id="item_in_enum"><a class="viewcode-back" href="../../source/core.html#core.utils.item_in_enum">[docs]</a><span class="k">def</span> <span class="nf">item_in_enum</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if an item exists in an enumeration.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : `str`</span>
<span class="sd">        Name of the item.</span>
<span class="sd">    enum : `enum.Enum`</span>
<span class="sd">        An instance of `enum.Enum`.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Raised if ``name`` is not in ``enum``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    value</span>
<span class="sd">        The value of ``name`` in ``enum``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># check whether the input name exists in the enumeration</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enum</span><span class="o">.</span><span class="n">__members__</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is not in </span><span class="si">{}</span><span class="s1"> enumeration. Valid names are: </span><span class="se">\n</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">enum</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                 <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;- </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span>
                                           <span class="n">enum</span><span class="o">.</span><span class="n">__members__</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">enum</span><span class="o">.</span><span class="n">__members__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">value</span></div>


<div class="viewcode-block" id="destack_tiff"><a class="viewcode-back" href="../../source/core.html#core.utils.destack_tiff">[docs]</a><span class="k">def</span> <span class="nf">destack_tiff</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">outpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Destack a TIFF with more than one band into a TIFF file for each band.</span>

<span class="sd">    Each band in ``image`` is saved to ``outpath`` as distinct TIFF file.</span>
<span class="sd">    The default filenames are: &quot;filename(``image``) + _B(i).tif&quot;, where i is</span>
<span class="sd">    the respective number of each band in ``image``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : `str` or `pathlib.Path`</span>
<span class="sd">        The TIFF to destack.</span>
<span class="sd">    outpath : `str`, optional</span>
<span class="sd">        Path to save the output TIFF files. The default is None. If None,</span>
<span class="sd">        ``outpath`` is the path to ``image``.</span>
<span class="sd">    remove : `bool`, optional</span>
<span class="sd">        Whether to remove ``image`` from disk after destacking. The default is</span>
<span class="sd">        False.</span>
<span class="sd">    overwrite : `bool`, optional</span>
<span class="sd">        Whether to overwrite existing TIFF files.</span>
<span class="sd">    suffix : `str`, optional</span>
<span class="sd">        String to append to the filename of ``image``. If specified, the TIFF</span>
<span class="sd">        filenames for each band in ``image`` are, &quot;filename(``image``) +</span>
<span class="sd">        + _B(i)_ + ``suffix``.tif&quot;. The default is &#39;&#39;.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        Raised if ``image`` does not exist.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># stop gdal printing warnings and errors to STDERR</span>
    <span class="n">gdal</span><span class="o">.</span><span class="n">PushErrorHandler</span><span class="p">(</span><span class="s1">&#39;CPLQuietErrorHandler&#39;</span><span class="p">)</span>

    <span class="c1"># raise Python exceptions for gdal errors</span>
    <span class="n">gdal</span><span class="o">.</span><span class="n">UseExceptions</span><span class="p">()</span>

    <span class="c1"># convert to pathlib.Path</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">image</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> does not exist.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>

    <span class="c1"># name of the TIFF</span>
    <span class="n">imgname</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">stem</span>

    <span class="c1"># default: output directory is equal to the input directory</span>
    <span class="k">if</span> <span class="n">outpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outpath</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">parent</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outpath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span>
        <span class="c1"># check if output directory exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">outpath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">outpath</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># open the TIFF</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>

    <span class="c1"># check whether the file was already processed</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">outpath</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">imgname</span> <span class="o">+</span> <span class="s1">&#39;_B*&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">img</span><span class="o">.</span><span class="n">RasterCount</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> already processed.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imgname</span><span class="p">))</span>

    <span class="c1"># destack the TIFF</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># image driver</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="s1">&#39;GTiff&#39;</span><span class="p">)</span>
        <span class="n">driver</span><span class="o">.</span><span class="n">Register</span><span class="p">()</span>

        <span class="c1"># image size and tiles</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">RasterXSize</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">RasterYSize</span>
        <span class="n">bands</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">RasterCount</span>

        <span class="c1"># print progress</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imgname</span><span class="p">))</span>

        <span class="c1"># iterate the bands of the raster</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">bands</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>

            <span class="c1"># read the data of band b</span>
            <span class="n">band</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>

            <span class="c1"># output file: replace for band name</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">outpath</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">imgname</span> <span class="o">+</span> <span class="s1">&#39;_B</span><span class="si">{:d}</span><span class="s1">.tif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">suffix</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;_</span><span class="si">{}</span><span class="s1">.tif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="p">))</span>
            <span class="n">outDs</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">band</span><span class="o">.</span><span class="n">DataType</span><span class="p">)</span>

            <span class="c1"># define output band</span>
            <span class="n">outband</span> <span class="o">=</span> <span class="n">outDs</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># write array to output band</span>
            <span class="n">outband</span><span class="o">.</span><span class="n">WriteArray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">outband</span><span class="o">.</span><span class="n">FlushCache</span><span class="p">()</span>

            <span class="c1"># Set the geographic information</span>
            <span class="n">outDs</span><span class="o">.</span><span class="n">SetProjection</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">GetProjection</span><span class="p">())</span>
            <span class="n">outDs</span><span class="o">.</span><span class="n">SetGeoTransform</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">())</span>

            <span class="c1"># clear memory</span>
            <span class="k">del</span> <span class="n">outband</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">outDs</span>

    <span class="c1"># remove old stacked GeoTIFF</span>
    <span class="k">del</span> <span class="n">img</span>
    <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="standard_eo_structure"><a class="viewcode-back" href="../../source/core.html#core.utils.standard_eo_structure">[docs]</a><span class="k">def</span> <span class="nf">standard_eo_structure</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">target_path</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">move</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="n">parse_landsat_scene</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Modify the directory structure of a remote sensing dataset.</span>

<span class="sd">    This function assumes that ``source_path`` points to a directory containing</span>
<span class="sd">    remote sensing data, where each file in ``source_path`` and its sub-folders</span>
<span class="sd">    should contain a scene identifier in its filename. The scene identifier is</span>
<span class="sd">    used to restructure the dataset.</span>

<span class="sd">    Currently, Landsat and Sentinel-2 datasets are supported.</span>

<span class="sd">    The directory tree in ``source_path`` is modified to the following</span>
<span class="sd">    structure in ``target_path``:</span>

<span class="sd">        target_path/</span>
<span class="sd">            scene_id_1/</span>
<span class="sd">                files matching scene_id_1</span>
<span class="sd">            scene_id_2/</span>
<span class="sd">                files matching scene_id_2</span>
<span class="sd">            .</span>
<span class="sd">            .</span>
<span class="sd">            .</span>
<span class="sd">            scene_id_n/</span>
<span class="sd">                files matching scene_id_n</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    source_path : `str` or `pathlib.Path`</span>
<span class="sd">        Path to the remote sensing dataset.</span>
<span class="sd">    target_path : `str` or `pathlib.Path`</span>
<span class="sd">        Path to save the restructured dataset.</span>
<span class="sd">    overwrite : `bool`, optional</span>
<span class="sd">        Whether to overwrite existing files in ``target_path``.</span>
<span class="sd">        The default is True.</span>
<span class="sd">    move : `bool`, optional</span>
<span class="sd">        Whether to move the files from ``source_path`` to ``target_path``. If</span>
<span class="sd">        True, files in ``source_path`` are moved to ``target_path``, if False,</span>
<span class="sd">        files in ``source_path`` are copied to ``target_path``. The default is</span>
<span class="sd">        False.</span>
<span class="sd">    parser : `function`, optional</span>
<span class="sd">        The scene identifier parsing function. Depends on the sensor of the</span>
<span class="sd">        dataset. See e.g., `pysegcnn.core.utils.parse_landsat_scene`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># create a directory for each scene</span>
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">source_path</span><span class="p">):</span>

        <span class="c1"># check if there are files in the current folder</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># iterate over the files to modify</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>

            <span class="c1"># get the path to the file</span>
            <span class="n">old_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

            <span class="c1"># get name of the scene</span>
            <span class="n">scene</span> <span class="o">=</span> <span class="n">parser</span><span class="p">(</span><span class="n">old_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scene</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                <span class="c1"># path to copy files not matching a scene identifier</span>
                <span class="n">new_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">target_path</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;misc&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

                <span class="c1"># file a warning if the file does not match a scene identifier</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> does not match a scene identifier. Copying &#39;</span>
                               <span class="s1">&#39;to </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">old_path</span><span class="p">),</span>
                                               <span class="n">new_path</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># the name of the scene</span>
                <span class="n">scene_name</span> <span class="o">=</span> <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

                <span class="c1"># define the new path to the file</span>
                <span class="n">new_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">target_path</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">scene_name</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

            <span class="c1"># move files to new directory</span>
            <span class="k">if</span> <span class="n">new_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> already exists.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_path</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">move</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">old_path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mv </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_path</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cp </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_path</span><span class="p">))</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">old_path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>

    <span class="c1"># remove old file location</span>
    <span class="k">if</span> <span class="n">move</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="extract_archive"><a class="viewcode-back" href="../../source/core.html#core.utils.extract_archive">[docs]</a><span class="k">def</span> <span class="nf">extract_archive</span><span class="p">(</span><span class="n">inpath</span><span class="p">,</span> <span class="n">outpath</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract files from an archive.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inpath : `str` or `pathlib.Path`</span>
<span class="sd">        Path to an archive.</span>
<span class="sd">    outpath : `str` or `pathlib.Path`</span>
<span class="sd">        Path to save extracted files.</span>
<span class="sd">    overwrite : `bool`, optional</span>
<span class="sd">        Whether to overwrite existing extracted files.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    subdir : str</span>
<span class="sd">        path to the extracted files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inpath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">inpath</span><span class="p">)</span>

    <span class="c1"># create the output directory</span>
    <span class="n">outpath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">outpath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">outpath</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># name of the archive</span>
    <span class="n">archive</span> <span class="o">=</span> <span class="n">inpath</span><span class="o">.</span><span class="n">stem</span>

    <span class="c1"># path to the extracted files</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">outpath</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">archive</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Overwriting: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Extracted files are located in: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">target</span>

    <span class="c1"># create output directory</span>
    <span class="n">target</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># read the archive</span>
    <span class="k">if</span> <span class="n">inpath</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tgz&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">inpath</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tar.gz&#39;</span><span class="p">):</span>
        <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">inpath</span><span class="p">,</span> <span class="s2">&quot;r:gz&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">inpath</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.zip&#39;</span><span class="p">):</span>
        <span class="n">tar</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">inpath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>

    <span class="c1"># extract files to the output directory</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Extracting: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">archive</span><span class="p">))</span>
    <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">target</span></div>


<div class="viewcode-block" id="read_landsat_metadata"><a class="viewcode-back" href="../../source/core.html#core.utils.read_landsat_metadata">[docs]</a><span class="k">def</span> <span class="nf">read_landsat_metadata</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse the Landsat metadata *_MTL.txt file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : `str` or `pathlib.Path`</span>
<span class="sd">        Path to a Landsat *_MTL.txt file.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        Raised if ``file`` does not exist.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    metadata : `dict`</span>
<span class="sd">        The metadata text file as dictionary, where each line is a (key, value)</span>
<span class="sd">        pair.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="c1"># check if the metadata file exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>

    <span class="c1"># read metadata file</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Parsing metadata file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">metafile</span><span class="p">:</span>
        <span class="c1"># iterate over the lines of the metadata file</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">metafile</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># the current line as (key, value pair)</span>
                <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>

                <span class="c1"># store current line in dictionary: skip lines defining the</span>
                <span class="c1"># parameter groups</span>
                <span class="k">if</span> <span class="s1">&#39;GROUP&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c1"># catch value error of line.split(&#39;=&#39;), i.e. if there is no &#39;=&#39;</span>
            <span class="c1"># sign in the current line</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>

    <span class="k">return</span> <span class="n">metadata</span></div>


<div class="viewcode-block" id="get_radiometric_constants"><a class="viewcode-back" href="../../source/core.html#core.utils.get_radiometric_constants">[docs]</a><span class="k">def</span> <span class="nf">get_radiometric_constants</span><span class="p">(</span><span class="n">metadata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieve the radiometric calibration constants.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    metadata : `dict`</span>
<span class="sd">        The dictionary returned by ``read_landsat_metadata``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    oli : `dict`</span>
<span class="sd">        Radiometric rescaling factors of the OLI sensor.</span>
<span class="sd">    tir : `dict`</span>
<span class="sd">        Thermal conversion constants of the TIRS sensor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># regular expression patterns matching the radiometric rescaling factors</span>
    <span class="n">oli_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;(RADIANCE|REFLECTANCE)_(MULT|ADD)_BAND_</span><span class="se">\\</span><span class="s1">d{1,2}&#39;</span><span class="p">)</span>
    <span class="n">tir_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;K(1|2)_CONSTANT_BAND_</span><span class="se">\\</span><span class="s1">d</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># rescaling factors to calculate top of atmosphere radiance and reflectance</span>
    <span class="n">oli</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span>
           <span class="n">oli_pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

    <span class="c1"># rescaling factors to calculate at-satellite temperatures in Kelvin</span>
    <span class="n">tir</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span>
           <span class="n">tir_pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">oli</span><span class="p">,</span> <span class="n">tir</span></div>


<div class="viewcode-block" id="landsat_radiometric_calibration"><a class="viewcode-back" href="../../source/core.html#core.utils.landsat_radiometric_calibration">[docs]</a><span class="k">def</span> <span class="nf">landsat_radiometric_calibration</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">outpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[],</span>
                                    <span class="n">radiance</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">remove_raw</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Radiometric calibration of Landsat Collection Level 1 scenes.</span>

<span class="sd">    Convert the Landsat OLI bands to top of atmosphere radiance or reflectance</span>
<span class="sd">    and the TIRS bands to top of atmosphere brightness temperature.</span>

<span class="sd">    Conversion is performed following the `equations`_ provided by the USGS.</span>

<span class="sd">    The filename of each band is extended by one of the following suffixes,</span>
<span class="sd">    depending on the type of the radiometric calibration:</span>

<span class="sd">        &#39;toa_ref&#39;: top of atmosphere reflectance</span>
<span class="sd">        &#39;toa_rad&#39;: top of atmopshere radiance</span>
<span class="sd">        &#39;toa_brt&#39;: top of atmosphere brightness temperature</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scene : `str` or `pathlib.Path`</span>
<span class="sd">        Path to a Landsat scene in digital number format.</span>
<span class="sd">    outpath : `str` or `pathlib.Path`, optional</span>
<span class="sd">        Path to save the calibrated images. The default is None, which means</span>
<span class="sd">        saving to ``scene``.</span>
<span class="sd">    exclude : `list` [`str`], optional</span>
<span class="sd">        Bands to exclude from the radiometric calibration. The default is [].</span>
<span class="sd">    radiance : `bool`, optional</span>
<span class="sd">        Whether to calculate top of atmosphere radiance. The default is False,</span>
<span class="sd">        which means calculating top of atmopshere reflectance.</span>
<span class="sd">    overwrite : `bool`, optional</span>
<span class="sd">        Whether to overwrite the calibrated images. The default is False.</span>
<span class="sd">    remove_raw : `bool`, optional</span>
<span class="sd">        Whether to remove the raw digitial number images. The default is True.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    FileNotFoundError</span>
<span class="sd">        Raised if ``scene`` does not exist.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>

<span class="sd">    .. _equations:</span>
<span class="sd">        https://www.usgs.gov/land-resources/nli/landsat/using-usgs-landsat-level-1-data-product</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scene</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">scene</span><span class="p">)</span>
    <span class="c1"># check if the input scene exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">scene</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> does not exist.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scene</span><span class="p">))</span>

    <span class="c1"># default: output directory is equal to the input directory</span>
    <span class="k">if</span> <span class="n">outpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outpath</span> <span class="o">=</span> <span class="n">scene</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outpath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span>
        <span class="c1"># check if output directory exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">outpath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">outpath</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># the scene metadata file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mpattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[mMtTlL].txt&#39;</span><span class="p">)</span>
        <span class="n">metafile</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">scene</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()</span> <span class="k">if</span> <span class="n">mpattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">))]</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">read_landsat_metadata</span><span class="p">(</span><span class="n">metafile</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Can not calibrate scene </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1"> does not exist.&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">scene</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_MTL.txt&#39;</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="c1"># radiometric calibration constants</span>
    <span class="n">oli</span><span class="p">,</span> <span class="n">tir</span> <span class="o">=</span> <span class="n">get_radiometric_constants</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

    <span class="c1"># log current Landsat scene ID</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Landsat scene id: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;LANDSAT_SCENE_ID&#39;</span><span class="p">]))</span>

    <span class="c1"># images to process</span>
    <span class="n">ipattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;B</span><span class="se">\\</span><span class="s1">d{1,2}(.*)</span><span class="se">\\</span><span class="s1">.[tT][iI][fF]&#39;</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">scene</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()</span> <span class="k">if</span> <span class="n">ipattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">))]</span>

    <span class="c1"># pattern to match calibrated images</span>
    <span class="n">cal_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;(</span><span class="si">{}</span><span class="s1">|</span><span class="si">{}</span><span class="s1">|</span><span class="si">{}</span><span class="s1">).[tT][iI][fF]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">SUFFIXES</span><span class="p">))</span>

    <span class="c1"># check if any images were already processe</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">images</span> <span class="k">if</span> <span class="n">cal_pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">))]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">processed</span><span class="p">):</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The following images have already been processed:&#39;</span><span class="p">)</span>

        <span class="c1"># images that were already processed</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">((</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">processed</span><span class="p">]))</span>

        <span class="c1"># overwrite: remove processed images and redo calibration</span>
        <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Preparing to overwrite ...&#39;</span><span class="p">)</span>

            <span class="c1"># remove processed images</span>
            <span class="k">for</span> <span class="n">toremove</span> <span class="ow">in</span> <span class="n">processed</span><span class="p">:</span>
                <span class="c1"># remove from disk</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">toremove</span><span class="p">)</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rm </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">toremove</span><span class="p">))</span>

                <span class="c1"># remove from list to process</span>
                <span class="n">images</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">toremove</span><span class="p">)</span>

        <span class="c1"># not overwriting, terminate calibration</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>

    <span class="c1"># exclude defined bands from the calibration procedure</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
        <span class="n">current_band</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;B</span><span class="se">\\</span><span class="s1">d{1,2}&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">current_band</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
            <span class="n">images</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="c1"># image driver</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="s1">&#39;GTiff&#39;</span><span class="p">)</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">Register</span><span class="p">()</span>

    <span class="c1"># iterate over the different bands</span>
    <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="c1"># read the image</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
        <span class="n">band</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># read data as array</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">band</span><span class="o">.</span><span class="n">ReadAsArray</span><span class="p">()</span>

        <span class="c1"># mask of erroneous values, i.e. mask of values &lt; 0</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&lt;</span> <span class="mi">0</span>

        <span class="c1"># output filename</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">outpath</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>

        <span class="c1"># get the current band</span>
        <span class="n">band</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;B</span><span class="se">\\</span><span class="s1">d{1,2}&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">image</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;BAND_&#39;</span><span class="p">)</span>

        <span class="c1"># check if the current band is a thermal band</span>
        <span class="k">if</span> <span class="n">band</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;BAND_10&#39;</span><span class="p">,</span> <span class="s1">&#39;BAND_11&#39;</span><span class="p">]:</span>

            <span class="c1"># output file name for TIRS bands</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_toa_brt.tif&#39;</span><span class="p">)</span>

            <span class="c1"># calculate top of atmosphere brightness temperature</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>

                <span class="c1"># top of atmosphere radiance</span>
                <span class="n">rad</span> <span class="o">=</span> <span class="p">(</span><span class="n">oli</span><span class="p">[</span><span class="s1">&#39;RADIANCE_MULT_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">band</span><span class="p">)]</span> <span class="o">*</span> <span class="n">data</span> <span class="o">+</span>
                       <span class="n">oli</span><span class="p">[</span><span class="s1">&#39;RADIANCE_ADD_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">band</span><span class="p">)])</span>

                <span class="c1"># top of atmosphere brightness temperature</span>
                <span class="n">den</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">tir</span><span class="p">[</span><span class="s1">&#39;K1_CONSTANT_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">band</span><span class="p">)]</span> <span class="o">/</span> <span class="n">rad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">toa</span> <span class="o">=</span> <span class="n">tir</span><span class="p">[</span><span class="s1">&#39;K2_CONSTANT_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">band</span><span class="p">)]</span> <span class="o">/</span> <span class="n">den</span>

                <span class="c1"># clear memory</span>
                <span class="k">del</span> <span class="n">den</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">rad</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># whether to calculate top of atmosphere radiance or reflectance</span>
            <span class="k">if</span> <span class="n">radiance</span><span class="p">:</span>

                <span class="c1"># output file name for OLI bands: radiance</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_toa_rad.tif&#39;</span><span class="p">)</span>

                <span class="c1"># calculate top of atmosphere radiance</span>
                <span class="n">toa</span> <span class="o">=</span> <span class="p">(</span><span class="n">oli</span><span class="p">[</span><span class="s1">&#39;RADIANCE_MULT_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">band</span><span class="p">)]</span> <span class="o">*</span> <span class="n">data</span> <span class="o">+</span>
                       <span class="n">oli</span><span class="p">[</span><span class="s1">&#39;RADIANCE_ADD_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">band</span><span class="p">)])</span>

                <span class="c1"># clear memory</span>
                <span class="k">del</span> <span class="n">data</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># output file name for OLI bands: reflectance</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_toa_ref.tif&#39;</span><span class="p">)</span>

                <span class="c1"># solar zenith angle in radians</span>
                <span class="n">zenith</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">90</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;SUN_ELEVATION&#39;</span><span class="p">]))</span>

                <span class="c1"># calculate top of the atmosphere reflectance</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="p">(</span><span class="n">oli</span><span class="p">[</span><span class="s1">&#39;REFLECTANCE_MULT_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">band</span><span class="p">)]</span> <span class="o">*</span> <span class="n">data</span> <span class="o">+</span>
                       <span class="n">oli</span><span class="p">[</span><span class="s1">&#39;REFLECTANCE_ADD_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">band</span><span class="p">)])</span>
                <span class="n">toa</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">zenith</span><span class="p">)</span>

                <span class="c1"># clear memory</span>
                <span class="k">del</span> <span class="n">ref</span><span class="p">,</span> <span class="n">data</span>

        <span class="c1"># mask erroneous values</span>
        <span class="n">toa</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># output file</span>
        <span class="n">outDs</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="n">img</span><span class="o">.</span><span class="n">RasterXSize</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">RasterYSize</span><span class="p">,</span>
                              <span class="n">img</span><span class="o">.</span><span class="n">RasterCount</span><span class="p">,</span> <span class="n">gdal</span><span class="o">.</span><span class="n">GDT_Float32</span><span class="p">)</span>
        <span class="n">outband</span> <span class="o">=</span> <span class="n">outDs</span><span class="o">.</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># write array</span>
        <span class="n">outband</span><span class="o">.</span><span class="n">WriteArray</span><span class="p">(</span><span class="n">toa</span><span class="p">)</span>
        <span class="n">outband</span><span class="o">.</span><span class="n">FlushCache</span><span class="p">()</span>

        <span class="c1"># Set the geographic information</span>
        <span class="n">outDs</span><span class="o">.</span><span class="n">SetProjection</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">GetProjection</span><span class="p">())</span>
        <span class="n">outDs</span><span class="o">.</span><span class="n">SetGeoTransform</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">())</span>

        <span class="c1"># clear memory</span>
        <span class="k">del</span> <span class="n">outband</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">outDs</span><span class="p">,</span> <span class="n">toa</span><span class="p">,</span> <span class="n">mask</span>

    <span class="c1"># check if raw images should be removed</span>
    <span class="k">if</span> <span class="n">remove_raw</span><span class="p">:</span>

        <span class="c1"># raw digital number images</span>
        <span class="n">_dn</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">scene</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()</span> <span class="k">if</span> <span class="n">ipattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="ow">and</span>
               <span class="ow">not</span> <span class="n">cal_pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))]</span>

        <span class="c1"># remove raw digital number images</span>
        <span class="k">for</span> <span class="n">toremove</span> <span class="ow">in</span> <span class="n">_dn</span><span class="p">:</span>
            <span class="c1"># remove from disk</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">toremove</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rm </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">toremove</span><span class="p">))</span>

    <span class="k">return</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Daniel Frisinghelli

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>